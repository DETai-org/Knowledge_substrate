# Ingest & RAG — Hybrid Model (Frontmatter + Index)
**v1.0** ♻️

## Зачем этот документ

Фиксируем каноническую модель хранения и доступа к публикациям в DET / DETai:

- **в Markdown-файле** хранится минимальная мета + контент (Source of Truth)
- **в БД/индексе** хранится всё производное и тяжёлое
- агенты и поиск работают **через индекс**, а не через чтение сырых файлов

Цель: избежать рассинхрона, обеспечить масштабируемость и снизить токенный “шум”.

---

## 1) Каноническая модель C: Гибрид

### Внутри файла (минимальная мета + контент)
Markdown-файл содержит:
- frontmatter (минимальная мета)
- тело контента (чистый текст)

Минимальная мета (ручная, стабильная):
- `id`
- `type`
- `authors`
- `date_ymd`
- `status`
- `taxonomy` (`rubric_ids`, `category_ids`, `keyword_ids`, `keywords_raw`)
- (опционально для research_publication) `journal`, `doi` и т.п. если удобно вести вручную

### В БД / индексе (тяжёлое и производное)
Хранится и обновляется ingestion pipeline:
- embeddings (document + chunk)
- chunk map / разбиение на чанки
- fulltext index
- вычисленные подсказки (например, keyword candidates)
- граф-связи (derived links)
- любые computed/derived поля

---

## 2) Главный принцип: Агент не читает сырые Markdown для поиска

Страх: агент нашёл документ в “таблице”, открыл файл и снова “съел” мету.

Правильный режим:
1) агент делает запрос к API/БД (фильтры/семантика/граф)
2) получает `id` + нужные поля (title/abstract/preview/snippet и т.п.)
3) только при необходимости запрашивает:
   - content документа
   - или конкретные чанки

Итого агент читает:
- metadata из БД (уже распарсенную)
- content по необходимости
- chunks, а не весь файл

В этой модели frontmatter внутри markdown не мешает:
- ingest съедает его один раз
- дальше агент работает с индексом

---

## 3) Два правила реализации, чтобы мета не мешала RAG

### Правило 1: Мета должна легко отделяться
Frontmatter всегда в начале файла и строго ограничен:
- YAML между `--- ... ---`
- или JSON-блок первым куском

Ingest обязан:
- вытащить мету
- удалить мету из чистого текста
- в embeddings отправлять только content

### Правило 2: Embeddings строятся не по всему файлу
Векторизация строится по:
- `content` без frontmatter
- чанкам тела текста
- (опционально) отдельно по title/abstract

Это соответствует модели:
- 1 vector per doc
- N vectors per chunks

---

## 4) Что НЕ класть в метаблок (чтобы не раздувать frontmatter)

Не хранить внутри Markdown:
- IDs embeddings
- chunk map
- extracted entities
- computed keyword suggestions
- derived graph links
- search index fields

Это всё относится к ingestion/индексу и должно жить в БД.

---

**Статус документа:** canonical  

**Последнее обновление:** 2026-01-15
