name: Create Linear issue on merge to main

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - Sync Blog Posts to Site
    types:
      - completed
    branches:
      - main

permissions:
  contents: write

jobs:
  create_linear_issue:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main
          persist-credentials: true
      - name: Проверка новых файлов в блогах
        id: detect
        shell: bash
        run: |
          python3 - <<'PY'
          import json
          import os
          import sys
          from pathlib import Path

          base_dir = Path("knowledge_core/source_of_truth/docs/publications/blogs")
          json_path = Path(".github/workflows/list_publication_blogs.json")
          data = json.loads(json_path.read_text(encoding="utf-8"))
          target_dirs = ["detai_site_blog", "personal_site_blog"]

          def list_files(dir_name: str) -> list[str]:
            dir_path = base_dir / dir_name
            return sorted(
              [
                item.name
                for item in dir_path.iterdir()
                if item.is_file() and item.name != "README.md"
              ]
            )

          missing = []
          for dir_name in target_dirs:
            known = set(data.get(dir_name, []))
            for file_name in list_files(dir_name):
              if file_name not in known:
                missing.append((dir_name, file_name))

          output_path = os.environ["GITHUB_OUTPUT"]
          if not missing:
            print("Новых файлов для публикации не найдено. Все файлы уже есть в JSON-списке.")
            with open(output_path, "a", encoding="utf-8") as fh:
              fh.write("has_new=false\n")
            sys.exit(0)

          dir_name, file_name = sorted(missing, key=lambda item: (item[0], item[1]))[0]
          print(f"Обнаружен новый файл: {dir_name}/{file_name}")
          with open(output_path, "a", encoding="utf-8") as fh:
            fh.write("has_new=true\n")
            fh.write(f"post_dir={dir_name}\n")
            fh.write(f"post_file={file_name}\n")
          PY
      - name: Create Linear issue for Site project
        if: ${{ steps.detect.outputs.has_new == 'true' }}
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
          LINEAR_PROJECT_ID: ${{ secrets.LINEAR_PROJECT_ID }}
          LINEAR_LABEL_ID_POST_TO_BLOG: ef1c4ff5-cbec-4ba2-9534-5a5158312e4f # Post to Blog
          LINEAR_ASSIGNEE_ID: 12db3c09-7c21-407b-bcac-20e8c697d8ea # Anton-Psy
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
          POST_DIR: ${{ steps.detect.outputs.post_dir }}
          POST_FILE: ${{ steps.detect.outputs.post_file }}
        shell: bash
        run: |
          python3 - <<'PY'
          import json
          import os
          import urllib.request
          from pathlib import Path
          api_key = os.environ["LINEAR_API_KEY"]
          team_id = os.environ["LINEAR_TEAM_ID"]
          project_id = os.environ["LINEAR_PROJECT_ID"]
          label_id_post_to_blog = os.environ["LINEAR_LABEL_ID_POST_TO_BLOG"]
          assignee_id = os.environ["LINEAR_ASSIGNEE_ID"]
          repo = os.environ["REPO"]
          sha = os.environ["SHA"]
          actor = os.environ["ACTOR"]
          post_dir = os.environ["POST_DIR"]
          post_file = os.environ["POST_FILE"]
          title = "Добавления нового поста в систему"
          prompt_template = Path(".github/workflows/prompt_2.md").read_text(encoding="utf-8").strip()
          desc = prompt_template.format(repo=repo, sha=sha, actor=actor)
          desc = desc.replace("Название файла:", f"Название файла: {post_dir}/{post_file}")
          label_ids = [label_id_post_to_blog]
          payload = {
          "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url title } } }",
          "variables": {
          "input": {
          "teamId": team_id,
          "projectId": project_id,
          "labelIds": label_ids,
          "assigneeId": assignee_id,
          "title": title,
          "description": desc
          }
          }
          }
          req = urllib.request.Request(
          "https://api.linear.app/graphql",
          data=json.dumps(payload).encode("utf-8"),
          headers={"Content-Type": "application/json", "Authorization": api_key}
          )
          print(urllib.request.urlopen(req).read().decode("utf-8"))
          PY
      - name: Обновление списка публикаций
        id: update_list
        if: ${{ steps.detect.outputs.has_new == 'true' }}
        shell: bash
        run: |
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          json_path = Path(".github/workflows/list_publication_blogs.json")
          data = json.loads(json_path.read_text(encoding="utf-8"))
          post_dir = os.environ["POST_DIR"]
          post_file = os.environ["POST_FILE"]
          output_path = os.environ["GITHUB_OUTPUT"]

          entries = list(data.get(post_dir, []))
          if post_file not in entries:
            entries.append(post_file)
            entries = sorted(entries)
            data[post_dir] = entries
            json_path.write_text(
              json.dumps(data, ensure_ascii=False, indent=2) + "\n",
              encoding="utf-8"
            )
            updated = "true"
          else:
            updated = "false"

          with open(output_path, "a", encoding="utf-8") as fh:
            fh.write(f"updated={updated}\n")
          PY
        env:
          POST_DIR: ${{ steps.detect.outputs.post_dir }}
          POST_FILE: ${{ steps.detect.outputs.post_file }}
      - name: Коммит и пуш обновленного списка
        if: ${{ steps.update_list.outputs.updated == 'true' }}
        shell: bash
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/workflows/list_publication_blogs.json
          git commit -m "chore(workflows): обновить список публикаций блогов"
          git push origin HEAD:main
