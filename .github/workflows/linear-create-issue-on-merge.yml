name: Create Linear issue on merge to main

on:
  push:
    branches:
      - main

jobs:
  create_linear_issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      - name: Create Linear issue for Site project
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
          LINEAR_PROJECT_ID: ${{ secrets.LINEAR_PROJECT_ID }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          ACTOR: ${{ github.actor }}
        shell: bash
        run: |
          python3 - <<'PY'
          import json
          import os
          import urllib.request
          from pathlib import Path
          api_key = os.environ["LINEAR_API_KEY"]
          team_id = os.environ["LINEAR_TEAM_ID"]
          project_id = os.environ["LINEAR_PROJECT_ID"]
          repo = os.environ["REPO"]
          sha = os.environ["SHA"]
          actor = os.environ["ACTOR"]
          title = "Добавления нового поста в систему"
          prompt_template = Path(".github/workflows/prompt.md").read_text(encoding="utf-8").strip()
          desc = prompt_template.format(repo=repo, sha=sha, actor=actor)
          payload = {
          "query": "mutation CreateIssue($input: IssueCreateInput!) { issueCreate(input: $input) { success issue { id identifier url title } } }",
          "variables": {
          "input": {
          "teamId": team_id,
          "projectId": project_id,
          "title": title,
          "description": desc
          }
          }
          }
          req = urllib.request.Request(
          "https://api.linear.app/graphql",
          data=json.dumps(payload).encode("utf-8"),
          headers={"Content-Type": "application/json", "Authorization": api_key}
          )
          print(urllib.request.urlopen(req).read().decode("utf-8"))
          PY
