name: Sync Blog Posts to Site

on:
  push:
    branches:
      - main
    paths:
      - 'knowledge_core/source_of_truth/docs/publications/blogs/detai_site_blog/**'
      - 'knowledge_core/source_of_truth/docs/publications/blogs/personal_site_blog/**'
      - '!knowledge_core/source_of_truth/docs/publications/blogs/detai_site_blog/README.md'
      - '!knowledge_core/source_of_truth/docs/publications/blogs/personal_site_blog/README.md'

jobs:
  sync-repos:
    runs-on: ubuntu-latest
    steps:
      # Шаг 1: Клонируем репозиторий базы знаний (Source Repo)
      - name: Checkout Source Repository (Knowledge_substrate)
        uses: actions/checkout@v2
        with:
          repository: DETai-org/Knowledge_substrate  # Исходный репозиторий
          token: ${{ secrets.GITHUB_TOKEN }}

      # Шаг 2: Клонируем целевой репозиторий (Target Repo)
      - name: Checkout Target Repository (Sites Repo)
        uses: actions/checkout@v2
        with:
          repository: DETai-org/sites  # Целевой репозиторий
          token: ${{ secrets.SITE_REPO_TOKEN }}
          path: target-repo  # Сохраняем в папку target-repo для дальнейшей работы

      # Шаг 3: Настройка идентификации Git
      - name: Set up Git identity
        run: |
          git config --global user.email "kolhonena@gmail.com"  # Cвой email
          git config --global user.name "Anton-Psy"  # Cвоё имя

      # Шаг 4: Копируем файлы из исходного репозитория в целевой
      - name: Copy Blog Posts to Site
        run: |
          target_path="target-repo/docs/publications/blogs"
          mkdir -p "$target_path/detai_site_blog"
          mkdir -p "$target_path/personal_site_blog"
          rsync -a --exclude 'Redmond*' knowledge_core/source_of_truth/docs/publications/blogs/detai_site_blog/ "$target_path/detai_site_blog/"
          rsync -a --exclude 'Redmond*' knowledge_core/source_of_truth/docs/publications/blogs/personal_site_blog/ "$target_path/personal_site_blog/"
          cd target-repo
          git add docs/publications/blogs/detai_site_blog docs/publications/blogs/personal_site_blog
          if git diff --cached --quiet; then
            echo "Изменений для коммита нет."
            exit 0
          fi
          git commit -m "Sync new blog posts"
          git fetch origin main
          for attempt in 1 2 3 4 5; do
            git pull --rebase origin main
            if git push; then
              exit 0
            fi
            echo "Не удалось отправить изменения (попытка ${attempt}). Повтор через ${attempt}0 секунд..."
            sleep "${attempt}0"
          done
          echo "Не удалось отправить изменения после 5 попыток."
          exit 1
