üß≠ **Initiative (Issue)**
**–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ —Å—Ö–æ–¥—Å—Ç–≤–∞ –¥–ª—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤**

# TODO ‚Äî Semantic Graph (Postgres + Ingest + Embeddings + API)

–û–ø–∏—Å–∞–Ω–∏–µ:
–≠—Ç–æ—Ç –Ω–∞–±–æ—Ä –∑–∞–¥–∞—á —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –≥—Ä–∞—Ñ–∞ –¥–ª—è publish‚Äë–ø–æ—Å—Ç–æ–≤:
1) –ë–î‚Äë—Å—Ö–µ–º–∞ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏,
2) –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ publish‚Äë–ø–æ—Å—Ç–æ–≤ –∏–∑ SoT,
3) —Ä–∞—Å—á—ë—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ similarity‚Äë–≥—Ä–∞—Ñ–∞,
4) API –¥–ª—è –≤—ã–¥–∞—á–∏ –≥—Ä–∞—Ñ–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ nodes + edges.
–°—á–∏—Ç–∞–µ–º –∑–∞–¥–∞—á—É –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–π, –∫–æ–≥–¥–∞ –≤—Å–µ Sub‚ÄëIssue –∑–∞–∫—Ä—ã—Ç—ã –∏ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–æ–±–ª—é–¥–µ–Ω—ã.

---

## Sub-Issue 1 ‚Äî DB migrations: pgvector + similarity_edges
–ö–æ—Ä–æ—Ç–∫–æ: –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å Postgres‚Äë—Å—Ö–µ–º—É –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –∏ undirected similarity‚Äëgraph.

## üéØ Purpose
–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ SQL‚Äë–º–∏–≥—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∫–ª—é—á–∞—é—Ç pgvector,
—Å–æ–∑–¥–∞—é—Ç —Ç–∞–±–ª–∏—Ü—É similarity‚Äë–≥—Ä–∞—Ñ–∞ –∏ —Ä–∞—Å—à–∏—Ä—è—é—Ç embeddings –±–µ–∑ –ª–æ–º–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.

## üì¶ Acceptance Tasks
- [x] –í–∫–ª—é—á–∏—Ç—å pgvector (CREATE EXTENSION IF NOT EXISTS vector).
  - Implementation Steps:
    - –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ pgvector –≤ –±–∞–∑–æ–≤—É—é –º–∏–≥—Ä–∞—Ü–∏—é knowledge_core.
- [x] –°–æ–∑–¥–∞—Ç—å knowledge.similarity_edges —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏ –∏ CHECK (source_id < target_id).
  - Implementation Steps:
    - –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –≤ –Ω–æ–≤–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä—ë–±–µ—Ä.
- [x] –î–æ–±–∞–≤–∏—Ç—å CHECK (weight –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ 0..1) –∏ UNIQUE (source_id, target_id, doc_type, method).
  - Implementation Steps:
    - –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω similarity –∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å —Ä–µ–±—Ä–∞ –ø–æ —Ç–∏–ø—É/–º–µ—Ç–æ–¥—É.
- [x] –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã: source_id, target_id, weight DESC.
  - Implementation Steps:
    - –°–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –ø–æ source/target –∏ —Å–æ—Ä—Ç–∏—Ä—É–µ–º—ã–π –∏–Ω–¥–µ–∫—Å –ø–æ weight.
- [x] –î–æ–±–∞–≤–∏—Ç—å FK –Ω–∞ knowledge.documents(id) —Å ON DELETE CASCADE (–µ—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞/—Ç–∏–ø –ø–æ–¥—Ö–æ–¥—è—Ç), –∏–Ω–∞—á–µ –æ–ø–∏—Å–∞—Ç—å –ø—Ä–∏—á–∏–Ω—É –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è FK.
  - Implementation Steps:
    - –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–∫–∞–∑ –æ—Ç FK –∏–∑‚Äë–∑–∞ –Ω–µ—Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ç–∏–ø–æ–≤ (documents.id = BIGINT, source/target_id = TEXT).
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å/—Å–æ–∑–¥–∞—Ç—å knowledge.embeddings –¥–ª—è doc‚Äëlevel embeddings –±–µ–∑ –ª–æ–º–∫–∏ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
  - Implementation Steps:
    - –†–∞—Å—à–∏—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É embeddings –ø–æ–ª—è–º–∏ doc_type, source_hash, updated_at.
- [x] –û–±–Ω–æ–≤–∏—Ç—å detai-core/workspace/db/README.md (pgvector, similarity_edges, undirected constraints).
  - Implementation Steps:
    - –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–∞—Ç–∫—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é, —Ç–∞–±–ª–∏—Ü–µ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è–º.

---

## Sub-Issue 2 ‚Äî Ingest: Extract publish-posts from SoT
–ö–æ—Ä–æ—Ç–∫–æ: —Å–æ–±—Ä–∞—Ç—å publish‚Äë–ø–æ—Å—Ç—ã –∏–∑ SoT –≤ –≤–∏–¥–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤.

## üéØ Purpose
–ò–∑–≤–ª–µ—á—å –≤—Å–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã —Ç–∏–ø–∞ post –∏–∑ Source of Truth (Markdown + frontmatter)
–∏ –ø—Ä–∏–≤–µ—Å—Ç–∏ –∏—Ö –∫ –µ–¥–∏–Ω–æ–º—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–∏—Ö —ç—Ç–∞–ø–æ–≤
(embeddings ‚Üí similarity graph ‚Üí DB/API).

## üì¶ Acceptance Tasks
- [x] –ü—Ä–æ–π—Ç–∏ –ø–æ –ø—É—Ç—è–º SoT —Å –ø–æ—Å—Ç–∞–º–∏, —Å—á–∏—Ç–∞—Ç—å markdown‚Äë—Ñ–∞–π–ª—ã, –∏–∑–≤–ª–µ—á—å frontmatter –∏ body.
  - Implementation Steps:
    - –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å ingest_pipeline/posts —Å –ø–æ–∏—Å–∫–æ–º markdown‚Äë—Ñ–∞–π–ª–æ–≤ –∏ –ø–∞—Ä—Å–∏–Ω–≥–æ–º frontmatter.
- [x] –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ publish‚Äë–ø–æ—Å—Ç—ã (type == "post", administrative.status == "publish").
  - Implementation Steps:
    - –û—Ç—Å–µ–∫–∞—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∏–ª—å—Ç—Ä–∞ meta.
- [x] –ü–æ—Å—Ç—Ä–æ–∏—Ç—å text_for_embedding (–æ—á–∏—Å—Ç–∫–∞ markdown, title + "\n\n" + body_text).
  - Implementation Steps:
    - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ—á–∏—Å—Ç–∫—É markdown –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º WP‚Äë12 –∏ —Å–±–æ—Ä–∫—É —Ç–µ–∫—Å—Ç–∞ –¥–ª—è embedding.
- [x] –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç –ø–æ—Å—Ç–∞ (id, title, authors, date_ymd, channels, taxonomy, text_for_embedding).
  - Implementation Steps:
    - –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å PostExtracted —Å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏/–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏, source_path –∏ source_hash.

---

## Sub-Issue 3 ‚Äî Embeddings & Graph Builder
–ö–æ—Ä–æ—Ç–∫–æ: —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ –∏ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å Top‚ÄëK –≥—Ä–∞—Ñ —Å–≤—è–∑–µ–π.

## üéØ –¶–µ–ª—å

–ü–æ—Å—Ç—Ä–æ–∏—Ç—å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –≥—Ä–∞—Ñ —Å–º—ã—Å–ª–æ–≤–æ–π –±–ª–∏–∑–æ—Å—Ç–∏ –¥–ª—è –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ç–∏–ø–∞ `post`:

* —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å **document-level embeddings** (1 –≤–µ–∫—Ç–æ—Ä –Ω–∞ –ø–æ—Å—Ç);
* –Ω–∞ –∏—Ö –æ—Å–Ω–æ–≤–µ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å **undirected weighted similarity graph**;
* —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å embeddings –∏ —Ä—ë–±—Ä–∞ –≥—Ä–∞—Ñ–∞ –≤ **Operational Store (Postgres)**.

–ì—Ä–∞—Ñ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è:

* –≤—ã—è–≤–ª–µ–Ω–∏—è —Å–º—ã—Å–ª–æ–≤—ã—Ö –∫–ª–∞—Å—Ç–µ—Ä–æ–≤;
* –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É –ø–æ—Å—Ç–∞–º–∏;
* –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å—Ç—É–ª–∞—Ç–æ–≤ **DET**.

---

## üì¶ Scope

### –í—Ö–æ–¥–∏—Ç

* —Ä–∞–±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ **Sub-Issue 2** (`PostExtracted[]`);
* document-level embeddings (–±–µ–∑ —á–∞–Ω–∫–æ–≤);
* –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ similarity edges (Top-K);
* —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ embeddings –∏ —Ä—ë–±–µ—Ä –≥—Ä–∞—Ñ–∞ –≤ –ë–î.

### –ù–µ –≤—Ö–æ–¥–∏—Ç

‚ùå chunk embeddings  
‚ùå RAG / QA  
‚ùå API –∏ UI  
‚ùå —Ä–∞–±–æ—Ç–∞ —Å draft-–¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏  
‚ùå –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤  

---

## üß© Execution Model

–í—ã—á–∏—Å–ª–µ–Ω–∏–µ embeddings –∏ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ similarity-–≥—Ä–∞—Ñ–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è **–≤–Ω—É—Ç—Ä–∏ self-hosted core-–∫–æ–Ω—Ç—É—Ä–∞**.

–ú–æ–¥–µ–ª—å –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è:

**GitHub Actions (–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è) + self-hosted runner (–∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ)**

–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ:

* PostgreSQL —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç –ª–æ–∫–∞–ª—å–Ω–æ –∏ –Ω–µ –æ—Ç–∫—Ä—ã—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç;
* –ø—Ä—è–º—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏–∑ GitHub-hosted runner –Ω–µ–≤–æ–∑–º–æ–∂–Ω—ã;
* –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è –¥–∂–æ–±–∞ –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è —Ä—è–¥–æ–º —Å –ë–î –∏ Knowledge Substrate.

GitHub Actions –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–µ–π,
—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ self-hosted runner, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–º –≤ —Ç–æ–º –∂–µ –∫–æ–Ω—Ç—É—Ä–µ, —á—Ç–æ –∏ PostgreSQL.

---

## üîê Secrets & Environment

–î–æ—Å—Ç—É–ø –∫ –≤–Ω–µ—à–Ω–∏–º —Å–µ—Ä–≤–∏—Å–∞–º –∏ –ë–î –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ environment variables.

–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

* `OPENAI_API_KEY` ‚Äî –∫–ª—é—á embedding-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞;
* –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î (—á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `.env` self-hosted core).

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

* —Å–µ–∫—Ä–µ—Ç—ã –Ω–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏;
* —Å–µ–∫—Ä–µ—Ç—ã –Ω–µ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è;
* –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ `OPENAI_API_KEY` –¥–æ–ª–∂–Ω–æ –ø—Ä–∏–≤–æ–¥–∏—Ç—å –∫ —è–≤–Ω–æ–π –æ—à–∏–±–∫–µ –∑–∞–ø—É—Å–∫–∞.

---

## ‚ñ∂ Runner / Entry Point

–î–æ–ª–∂–µ–Ω —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å **–æ–¥–∏–Ω –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π entrypoint** –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞:

```
extract ‚Üí embeddings ‚Üí similarity graph ‚Üí persist
```

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:

* entrypoint –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ GitHub Actions job –Ω–∞ self-hosted runner;
* –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (`K`, `min_similarity`, –º–æ–¥–µ–ª—å) –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–ª–∏ env;
* entrypoint –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω:

  * –∏–∑ workflow,
  * –ª–æ–∫–∞–ª—å–Ω–æ,
  * –≤ –±—É–¥—É—â–µ–º –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é;
* entrypoint –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç API –∏–ª–∏ UI —Å–ª–æ—è.

---

## üì• –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

–ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ `PostExtracted`, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –∏–∑ **Sub-Issue 2**, —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –ø–æ–ª—è–º–∏:

* `id`
* `text_for_embedding`
* `source_hash`
* –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (title, year, channels, taxonomy –∏ —Ç.–¥.)

–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è **—Ç–æ–ª—å–∫–æ publish-–ø–æ—Å—Ç—ã**.

---

## üß† Embeddings

### –¢–∏–ø embeddings

* Document-level embeddings
* 1 embedding = 1 post

### –ü—Ä–æ–≤–∞–π–¥–µ—Ä / –º–æ–¥–µ–ª—å

* –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å **–ø—Ä–æ–≤–∞–π–¥–µ—Ä-–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–æ–π**;
* –º–æ–¥–µ–ª—å –∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –∂—ë—Å—Ç–∫–æ –Ω–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ;
* –≤—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –º–æ–¥–µ–ª–∏ (OpenAI / –ª–æ–∫–∞–ª—å–Ω–∞—è / –∏–Ω–∞—è) –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —á–∞—Å—Ç—å—é Sub-Issue.

–û–∂–∏–¥–∞–Ω–∏—è:

* –ø–æ–¥–¥–µ—Ä–∂–∫–∞ batch-–æ–±—Ä–∞–±–æ—Ç–∫–∏;
* –ø–µ—Ä–µ–¥–∞—á–∞ API-–∫–ª—é—á–∞ —á–µ—Ä–µ–∑ environment variables;
* —Ä–∞–∑—É–º–Ω—ã–µ –ª–∏–º–∏—Ç—ã (–Ω–µ –ø–æ –æ–¥–Ω–æ–º—É –¥–æ–∫—É–º–µ–Ω—Ç—É –∑–∞ –∑–∞–ø—Ä–æ—Å).

---

## üîÅ Source Hash & Idempotency

### source_hash

* –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `source_hash`, —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω—ã–π –Ω–∞ —ç—Ç–∞–ø–µ Extract (Sub-Issue 2);
* —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤–º–µ—Å—Ç–µ —Å embedding –≤ –ë–î.

### –ü–æ–≤–µ–¥–µ–Ω–∏–µ

* –µ—Å–ª–∏ embedding –¥–ª—è `(doc_id, doc_type, model)` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ `source_hash` –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è ‚Äî –ø–µ—Ä–µ—Å—á—ë—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è;
* –µ—Å–ª–∏ `source_hash` –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–ª–∏ embedding –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî embedding –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è.

---

## üóÑ –•—Ä–∞–Ω–µ–Ω–∏–µ embeddings

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ `knowledge.embeddings`.

–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞:

* upsert –ø–æ `(doc_id, doc_type, model)`;
* –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ embedding –∏ `updated_at` –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `source_hash`.

---

## ‚úçÔ∏è Text Normalization

### –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

* –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ lowercase;
* –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–±–µ–ª–æ–≤.

### –ù–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è

‚ùå —É–¥–∞–ª–µ–Ω–∏–µ stop-words  
‚ùå –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è / —Å—Ç–µ–º–º–∏–Ω–≥  
‚ùå –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –ø—Ä–µ–¥–æ–±—Ä–∞–±–æ—Ç–∫–∞  

–ü—Ä–∏—á–∏–Ω–∞: embedding-–º–æ–¥–µ–ª–∏ –ª—É—á—à–µ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º.

---

## üìê Similarity Metric

### –ú–µ—Ç—Ä–∏–∫–∞

* Cosine similarity.

### –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ

* —Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–µ-—Ñ–∞–∫—Ç–æ –¥–ª—è semantic similarity;
* –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç–Ω–æ—Å—Ç—å –∫ –¥–ª–∏–Ω–µ –≤–µ–∫—Ç–æ—Ä–∞;
* –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω (0..1).

---

## üï∏ –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∞

### –°—Ç—Ä–∞—Ç–µ–≥–∏—è

* Top-K per document.

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

* `K` –∏ `min_similarity` –∑–∞–¥–∞—é—Ç—Å—è –∫–∞–∫ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.

–ù–∞—á–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:

* `K = 8`
* `min_similarity = 0.75`

### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

* –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –Ω–µ –±–æ–ª–µ–µ `K` —Å–≤—è–∑–µ–π;
* —Å–≤—è–∑–∏ —Å `similarity < min_similarity` –æ—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è;
* –≥—Ä–∞—Ñ undirected:

  * —Ä—ë–±—Ä–∞ –Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –∫–∞–∫ `(min(idA, idB), max(idA, idB))`.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–µ –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è.

---

## üîÑ –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–µ—Ä–µ—Å—á—ë—Ç–∞ –≥—Ä–∞—Ñ–∞

### –†–µ—à–µ–Ω–∏–µ

–ò–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–∞—è, —Å –ø—Ä–æ—Å—Ç–æ–π –º–æ–¥–µ–ª—å—é.

–ü–æ–≤–µ–¥–µ–Ω–∏–µ:

* embeddings –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –∏–∑–º–µ–Ω–∏–≤—à–∏–º—Å—è `source_hash`;
* similarity edges –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—é—Ç—Å—è –¥–ª—è –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤;
* –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ—Å—á—ë—Ç –≥—Ä–∞—Ñ–∞ –∫–∞–∫ fallback (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –∑–∞–ø—É—Å–∫–∞).

–ù–∞ —Å—Ç–∞—Ä—Ç–µ –¥–æ–ø—É—Å—Ç–∏–º–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞,
–µ—Å–ª–∏ —ç—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –∫–æ–¥,
–Ω–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–æ–ª–∂–µ–Ω –ø–æ–∑–≤–æ–ª—è—Ç—å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –≤ –±—É–¥—É—â–µ–º.

---

## üóÑ –•—Ä–∞–Ω–µ–Ω–∏–µ similarity edges

–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∞–±–ª–∏—Ü–∞ `knowledge.similarity_edges`.

–ü—Ä–∞–≤–∏–ª–∞:

* upsert –ø–æ `(source_id, target_id, doc_type, method)`;
* `method = 'topk'`;
* —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `k` –∏ `min_similarity` –¥–ª—è —Ç—Ä–∞—Å—Å–∏—Ä—É–µ–º–æ—Å—Ç–∏;
* —Å—Ç–∞—Ä—ã–µ —Ä—ë–±—Ä–∞ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ –º–æ–≥—É—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω—ã –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π –Ω–æ–≤—ã—Ö.

---

## ‚úÖ Acceptance Criteria (Definition of Done)

Sub-Issue 3 —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –µ—Å–ª–∏:

* –î–ª—è –≤—Å–µ—Ö publish-–ø–æ—Å—Ç–æ–≤ —Ä–∞—Å—Å—á–∏—Ç–∞–Ω—ã document embeddings;
* Embeddings –Ω–µ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è, –µ—Å–ª–∏ source_hash –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è;
* –ü–æ—Å—Ç—Ä–æ–µ–Ω undirected similarity graph (Top-K);
* –†—ë–±—Ä–∞ –∏ embeddings —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Postgres;
* –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä—ë–±–µ—Ä –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç ‚â§ K;
* –ù–µ—Ç —Å–≤—è–∑–µ–π —Å weight < min_similarity;
* –ö–æ–¥ –Ω–µ –∑–∞–≤–∏—Å–∏—Ç –∂—ë—Å—Ç–∫–æ –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ embedding-–ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

---

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

Chunk embeddings –∏ RAG ‚Äî —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø.

–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –ø–æ—Å–ª–µ –ø–æ—è–≤–ª–µ–Ω–∏—è –∏—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤.

–ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∞ (communities) –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ –¥–∞–Ω–Ω—ã–π Sub-Issue.

---

## Sub-Issue 3a ‚Äî Embeddings & Graph Builder (PR scope)
–ö–æ—Ä–æ—Ç–∫–æ: —Å–¥–µ–ª–∞—Ç—å runnable –ø–∞–π–ø–ª–∞–π–Ω embeddings + similarity graph —Å –∫–æ–Ω—Ñ–∏–≥–æ–º –∏ self-hosted –∑–∞–ø—É—Å–∫–æ–º.

## üéØ Purpose
–°–æ–±—Ä–∞—Ç—å —Ä–∞–±–æ—á–∏–π –ø–∞–π–ø–ª–∞–π–Ω –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∏ self-hosted –∑–∞–ø—É—Å–∫–∞, –∫–æ—Ç–æ—Ä—ã–π –±–µ—Ä—ë—Ç publish‚Äë–ø–æ—Å—Ç—ã,
—Å—á–∏—Ç–∞–µ—Ç embeddings, —Å—Ç—Ä–æ–∏—Ç similarity graph –∏ –ø–∏—à–µ—Ç –≤—Å—ë –≤ Postgres —Å –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å—é.

## üì¶ Acceptance Tasks
- [x] –î–æ–±–∞–≤–∏—Ç—å config.json –∏ –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç CLI ‚Üí config ‚Üí env ‚Üí defaults.
  - Implementation Steps:
    - –°–æ–∑–¥–∞—Ç—å `knowledge_core/ingest_pipeline/config.json` –∏ –∑–∞–≥—Ä—É–∑–∫—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ –ø–∞–π–ø–ª–∞–π–Ω–µ.
- [x] –û–±–µ—Å–ø–µ—á–∏—Ç—å runnable CLI entrypoint –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ª–æ–≥–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–æ—Å—Ç–æ–≤/embeddings/edges.
  - Implementation Steps:
    - –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã CLI, –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø–æ—Å—Ç—ã, –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω–Ω—ã–µ embeddings –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ edges.
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å: retry —Å backoff, —Å–Ω–∏–∂–µ–Ω–∏–µ batch –∏ –ª–∏–º–∏—Ç –¥–ª–∏–Ω—ã —Ç–µ–∫—Å—Ç–∞.
  - Implementation Steps:
    - –î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ç—Ä–∞–∏, —É–º–µ–Ω—å—à–µ–Ω–∏–µ batch –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏ —É—Å–µ—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ —Å –ª–æ–≥–æ–º.
- [x] –î–æ–±–∞–≤–∏—Ç—å preflight, dry-run –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–µ –ª–æ–≥–∏ —Å run_id/stage.
  - Implementation Steps:
    - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å preflight check, dry-run —Ä–µ–∂–∏–º –∏ stage-–ª–æ–≥–∏ —Å —Å—á—ë—Ç—á–∏–∫–∞–º–∏.
- [x] –î–æ–±–∞–≤–∏—Ç—å GitHub Actions workflow –¥–ª—è self-hosted runner.
  - Implementation Steps:
    - –°–æ–∑–¥–∞—Ç—å workflow —Å `workflow_dispatch`, —É—Å—Ç–∞–Ω–æ–≤–∫–æ–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –∏ –∑–∞–ø—É—Å–∫–æ–º –ø–∞–π–ø–ª–∞–π–Ω–∞.
- [x] –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤ README, —á—Ç–æ —Å–µ–∫—Ä–µ—Ç—ã –∏–¥—É—Ç —á–µ—Ä–µ–∑ env (–ª–æ–∫–∞–ª—å–Ω–æ –∏ Actions).
  - Implementation Steps:
    - –û–±–Ω–æ–≤–∏—Ç—å ingest_pipeline/README.md —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏ –ø–æ env –∏ config.

---

## Sub-Issue 4 ‚Äî API: Expose similarity graph endpoint
–ö–æ—Ä–æ—Ç–∫–æ: –æ—Ç–¥–∞—Ç—å publish‚Äë–≥—Ä–∞—Ñ —á–µ—Ä–µ–∑ API –≤ —Ñ–æ—Ä–º–∞—Ç–µ nodes + edges.

–ü—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è –∑–∞–¥–∞—á–∞:
–î–æ–±–∞–≤–∏—Ç—å API endpoint –¥–ª—è publish‚Äë–≥—Ä–∞—Ñ–∞.

–ß–µ–∫–±–æ–∫—Å—ã:
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `/graph`, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π nodes –∏ edges.
- [ ] –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤—ã–±–æ—Ä–∫—É publish‚Äë–ø–æ—Å—Ç–∞–º–∏ –∏ –≤–∞–ª–∏–¥–Ω—ã–º–∏ —Ä—ë–±—Ä–∞–º–∏.
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã: channel, year_from/year_to, rubric_id, category_id, limit_nodes.
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ JSON —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É –∏ –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç—Å—è Next.js.

---

new üÜï –û—Å–ª–∞–±–∏—Ç—å preflight‚Äë–ø—Ä–æ–≤–µ—Ä–∫—É DATABASE_URL –≤ –ø–æ–ª—å–∑—É –ø–æ–ª–Ω–æ–≥–æ DSN.
new üÜï –°–¥–µ–ª–∞—Ç—å OPENAI_API_KEY —É—Å–ª–æ–≤–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π (dry‚Äërun / non‚Äëopenai).
new üÜï –î–æ–±–∞–≤–∏—Ç—å structured log –¥–ª—è –æ—à–∏–±–æ–∫ preflight.
new üÜï –î–æ–±–∞–≤–∏—Ç—å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é publish‚Äë–ø–æ—Å—Ç–æ–≤ –ø–æ administrative.id —Å prefer_channel.
