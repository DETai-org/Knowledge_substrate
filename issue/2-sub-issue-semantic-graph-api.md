# Sub-Issue 2: Semantic Graph API (v1) & API Service Hardening

## Title
–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API-—Å–µ—Ä–≤–∏—Å semantic graph –¥–ª—è publish-–ø–æ—Å—Ç–æ–≤ —Å –±–∞–∑–æ–≤—ã–º production-–∫–æ–Ω—Ç—É—Ä–æ–º.

## Purpose üéØ
–ü–æ—Å–ª–µ –º–µ—Ä–¥–∂–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —É—Å—Ç–æ–π—á–∏–≤—ã–π API-—Å–ª–æ–π –¥–ª—è –≤—ã–¥–∞—á–∏ semantic graph –≤ —Ñ–æ—Ä–º–∞—Ç–µ `nodes + edges` —á–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π endpoint `/v1/graph`.  
–≠—Ç–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç data-pipeline (Sub-Issue 1) –∫ –ø–æ—Ç—Ä–µ–±–ª—è–µ–º–æ–º—É —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –¥–ª—è —Å–∞–π—Ç–∞/–∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç Epic –∫ –ø–µ—Ä–≤–æ–º—É —Ä–µ–ª–∏–∑–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é knowledge layer.

---

## Tasks (Acceptance Checklist)

- [ ] **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ API-—Å–µ—Ä–≤–∏—Å–∞: –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è FastAPI –ø–æ –º–æ–¥—É–ª—è–º**
  1. –í–Ω—É—Ç—Ä–∏ `detai-core/api/app/` –≤—ã–¥–µ–ª–∏—Ç—å:
     - `main.py` (—Å–æ–∑–¥–∞–Ω–∏–µ app + middleware + include_router),
     - `routers/health.py`,
     - `routers/graph.py`,
     - `schemas/graph.py`,
     - `services/graph_query.py`,
     - `core/config.py` (env/config),
     - `core/logging.py` (structured logging).
  2. –£–±—Ä–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É SQL –∏–∑ `main.py` –≤ service-—Å–ª–æ–π.
  3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å `/health` (–∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å breaking-change –≤ Notes).

- [ ] **–°–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∫–∞–Ω–æ–Ω–∏—á–Ω—É—é –º–æ–¥–µ–ª—å metadata-—É–∑–ª–æ–≤ –¥–ª—è graph API v1**
  1. –î–æ–±–∞–≤–∏—Ç—å –≤ DDL –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É `knowledge.doc_metadata` (–∏–ª–∏ —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç) —Å `doc_id TEXT PRIMARY KEY` –∫–∞–∫ canonical SoT id (`administrative.id`).
  2. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –ø–æ–ª–µ–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ v1: `year` (–∏–ª–∏ `date_ymd`), `channels`, `authors`, `rubric_ids`, `category_ids`, `doc_type`, `updated_at`, `meta`.
  3. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Ç–∏–ø—ã –ø–æ–ª–µ–π (–º–∞—Å—Å–∏–≤—ã `TEXT[]` –∏–ª–∏ `JSONB`) –∏ –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è API.
  4. –Ø–≤–Ω–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ `knowledge.documents.id (BIGSERIAL)` –Ω–µ —è–≤–ª—è–µ—Ç—Å—è canonical id –¥–ª—è semantic graph.
     
____

- [ ] **–í–≤–µ—Å—Ç–∏ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä ingest-–ø–∞–π–ø–ª–∞–π–Ω–∞ –∏ —Ä–∞–∑–Ω–µ—Å—Ç–∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏ –ø–æ —ç—Ç–∞–ø–∞–º**

  1) –°–æ–∑–¥–∞—Ç—å –µ–¥–∏–Ω—ã–π CLI-–æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä
     - –î–æ–±–∞–≤–∏—Ç—å `knowledge_core/ingest_pipeline/run_ingest.py` (–∏–ª–∏ `ingest_pipeline/run.py`) –∫–∞–∫ –µ–¥–∏–Ω—É—é —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞.
     - –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω —É–º–µ—Ç—å –∑–∞–ø—É—Å–∫–∞—Ç—å —ç—Ç–∞–ø—ã –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏ –≤—ã–±–æ—Ä–æ—á–Ω–æ:
       - `--stage metadata`
       - `--stage embeddings`
       - `--stage edges`
       - `--stage all` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
     - –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –Ω–µ–Ω—É–ª–µ–≤–æ–π exit code –ø—Ä–∏ –æ—à–∏–±–∫–µ –ª—é–±–æ–≥–æ —ç—Ç–∞–ø–∞ (–∏ –ø–µ—á–∞—Ç–∞—Ç—å –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ).

  2) –í—ã–¥–µ–ª–∏—Ç—å —ç—Ç–∞–ø materialization metadata (SoT ‚Üí Operational Store)
     - –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥—É–ª—å `knowledge_core/ingest_pipeline/metadata/metadata_ingest.py` (–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã–π –ø–∞–∫–µ—Ç).
     - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å idempotent upsert –≤ `knowledge.doc_metadata` –ø–æ –∫–ª—é—á—É `doc_id = administrative.id`.
     - –ú–∞–ø–ø–∏–Ω–≥ –±–µ–∑ –ø–æ—Ç–µ—Ä—å:
       - `administrative.id` ‚Üí `doc_id`
       - `administrative.date_ymd` ‚Üí `date_ymd` (–∏/–∏–ª–∏ –≤—ã—á–∏—Å–ª—è–µ–º—ã–π `year`)
       - `administrative.authors` ‚Üí `authors`
       - `administrative.channels` ‚Üí `channels`
       - `descriptive.taxonomy.rubric_ids` ‚Üí `rubric_ids`
       - `descriptive.taxonomy.category_ids` ‚Üí `category_ids`
     - –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π + –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –ª–æ–≥–∏ –ø–æ –ø—Ä–æ–ø—É—Å–∫–∞–º/–Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏.

  3) –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ—Ñ–æ—Ä–º–∏—Ç—å —ç—Ç–∞–ø embeddings
     - –≠—Ç–∞–ø embeddings –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º —ç—Ç–∞–ø–æ–º (CLI/—Ñ—É–Ω–∫—Ü–∏—è), –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.
     - –û–Ω –Ω–µ –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å –∑–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—é metadata (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏).

  4) –°–æ—Ö—Ä–∞–Ω–∏—Ç—å/–æ—Ñ–æ—Ä–º–∏—Ç—å —ç—Ç–∞–ø –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è semantic edges
     - –≠—Ç–∞–ø edges –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º —ç—Ç–∞–ø–æ–º (CLI/—Ñ—É–Ω–∫—Ü–∏—è), –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ.
     - –û–Ω –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∏–π `doc_id` (SoT administrative.id) –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —Ä—ë–±—Ä–∞ –≤ `knowledge.similarity_edges`.

  5) –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π –∑–∞–ø—É—Å–∫ –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ + –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—é ‚Äúall‚Äù
     - –ö–∞–∂–¥—ã–π —ç—Ç–∞–ø –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é —Ç–æ—á–∫—É –∑–∞–ø—É—Å–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `python -m ... --stage X` –∏–ª–∏ –ø—Ä—è–º–æ–π –º–æ–¥—É–ª—å–Ω—ã–π CLI).
     - –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä `--stage all` –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω—è—Ç—å —ç—Ç–∞–ø—ã –≤ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ:
       1) metadata ‚Üí 2) embeddings ‚Üí 3) edges
     - –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ Codex –º–æ–∂–µ—Ç —Ä–∞–∑–Ω–µ—Å—Ç–∏ —Ç–µ–∫—É—â–∏–π `graph_builder/pipeline.py` (‚âà900 —Å—Ç—Ä–æ–∫) –Ω–∞ –º–æ–¥—É–ª–∏ (`extract/transform/persist/utils`) —Ç–∞–∫, —á—Ç–æ–±—ã:
       - –ª–æ–≥–∏–∫–∞ –±—ã–ª–∞ —á–∏—Ç–∞–µ–º–æ–π,
       - —ç—Ç–∞–ø—ã –±—ã–ª–∏ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–º–∏ –∏–∑ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞,
       - –Ω–µ –±—ã–ª–æ –º–æ–Ω–æ–ª–∏—Ç–Ω–æ–≥–æ ‚Äú–≤—Å—ë –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ‚Äù.

  6) –°–¥–µ–ª–∞—Ç—å ‚Äú—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ‚Äù –ª–æ–≥–∏ —Å —ç–º–æ–¥–∂–∏ –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (–∫–∞–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç –ø–∞–π–ø–ª–∞–π–Ω–∞)
     - –í–≤–µ—Å—Ç–∏ –µ–¥–∏–Ω—ã–π –ª–æ–≥-—Ö–µ–ª–ø–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, `ingest_pipeline/logging.py`) –∏ –æ–±—è–∑–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ –≤–æ –≤—Å–µ—Ö —ç—Ç–∞–ø–∞—Ö –∏ –≤ –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–µ.
     - –õ–æ–≥–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø–æ–Ω—è—Ç–Ω—ã–º–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ: –∫—Ä–∞—Ç–∫–∞—è —Ñ—Ä–∞–∑–∞ + –∫–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è.
     - –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è (—Å —ç–º–æ–¥–∂–∏):
       - `üöÄ start` (run_id, stage)
       - `üì• read` (—Å–∫–æ–ª—å–∫–æ –ø–æ—Å—Ç–æ–≤/—Ñ–∞–π–ª–æ–≤)
       - `üß± upsert` (—Ç–∞–±–ª–∏—Ü–∞, –≤—Å—Ç–∞–≤–ª–µ–Ω–æ/–æ–±–Ω–æ–≤–ª–µ–Ω–æ)
       - `üß† embeddings` (–º–æ–¥–µ–ª—å, docs_count)
       - `üï∏Ô∏è edges` (edges_count, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã k/min_similarity)
       - `‚úÖ done` (duration_ms)
       - `‚ö†Ô∏è warn` (skip_reason, doc_id)
       - `‚ùå error` (stage, doc_id/source_path, –∫—Ä–∞—Ç–∫–∞—è –ø—Ä–∏—á–∏–Ω–∞)
     - –ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö: –ø–µ—á–∞—Ç–∞—Ç—å ‚Äú—á—Ç–æ —É–ø–∞–ª–æ + –Ω–∞ –∫–∞–∫–æ–º doc_id/—Ñ–∞–π–ª–µ + —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ‚Äù (–±–µ–∑ –ø—Ä–æ—Å—Ç—ã–Ω–µ–π stacktrace –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é; stacktrace ‚Äî –ø–æ —Ñ–ª–∞–≥—É `--debug`).

  7) –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º–æ—Å—Ç—å
     - –û–±–Ω–æ–≤–∏—Ç—å README —Å ‚Äú–∫–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å‚Äù:
       - –∑–∞–ø—É—Å–∫ –æ–¥–Ω–æ–≥–æ —ç—Ç–∞–ø–∞
       - –∑–∞–ø—É—Å–∫ `--stage all`
       - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ env (DB_DSN / OPENAI_API_KEY / paths)
     - –î–æ–±–∞–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ smoke-–ø—Ä–æ–≤–µ—Ä–∫–∏ (–Ω–∞ —É—Ä–æ–≤–Ω–µ –∫–æ–¥–∞/—Å–∫—Ä–∏–ø—Ç–∞):
       - `metadata` –ø–∏—à–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤ `knowledge.doc_metadata`
       - `embeddings` –ø–∏—à–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤ `knowledge.embeddings`
       - `edges` –ø–∏—à–µ—Ç —Å—Ç—Ä–æ–∫–∏ –≤ `knowledge.similarity_edges`
____
     
- [ ] **–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∏ –≤–Ω–µ–¥—Ä–∏—Ç—å –∫–∞–Ω–æ–Ω–∏—á–Ω—ã–π join –¥–ª—è –≥—Ä–∞—Ñ–∞: `similarity_edges -> doc_metadata`**
  1. –í service-—Å–ª–æ–µ `/v1/graph` –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `source_id/target_id` –∏–∑ `knowledge.similarity_edges` –∫–∞–∫ `doc_id` –¥–ª—è join —Å `knowledge.doc_metadata`.
  2. –û–ø–∏—Å–∞—Ç—å SQL-—Å—Ç—Ä–∞—Ç–µ–≥–∏—é –≤—ã–±–æ—Ä–∫–∏: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è doc_id –ø–æ metadata -> –≤—ã–±–æ—Ä–∫–∞ —Ä—ë–±–µ—Ä —Ç–æ–ª—å–∫–æ –º–µ–∂–¥—É –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ doc_id -> —Å–±–æ—Ä–∫–∞ `nodes + edges + meta`.
  3. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏: —Ä—ë–±—Ä–∞ –±–µ–∑ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π metadata-–Ω–æ–¥—ã –Ω–µ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –≤—ã–¥–∞—á—É –∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–∞–∫ data-gap.
  4. –Ø–≤–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ v1 –æ—Ç `knowledge.documents.meta`, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –º–∞—Ç–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞.

- [ ] **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ graph API v1**
  1. –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –ø–æ `year` (–∏–ª–∏ `date_ymd`) –≤ `knowledge.doc_metadata`.
  2. –î–æ–±–∞–≤–∏—Ç—å GIN-–∏–Ω–¥–µ–∫—Å—ã –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏—è–º —Ñ–∏–ª—å—Ç—Ä–æ–≤ (`channels`, `authors`, `rubric_ids`, `category_ids`) –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è.
  3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–µ–∫—É—â–∏–µ –∏–Ω–¥–µ–∫—Å—ã `knowledge.similarity_edges` (`source_id`, `target_id`, `weight`) –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –∫–æ–Ω–µ—á–Ω–æ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∑–∞–ø—Ä–æ—Å–∞.
  4. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è `limit_nodes` –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ `truncated` –ø—Ä–∏ –±–æ–ª—å—à–∏—Ö –≤—ã–±–æ—Ä–∫–∞—Ö.

- [ ] **–ï–¥–∏–Ω—ã–π data-contract ingest ‚Üî API –¥–ª—è v1 (–±–µ–∑ –¥–≤–æ–π–Ω–æ–π —Ç—Ä–∞–∫—Ç–æ–≤–∫–∏ DoD)**
  1. –°–æ–±—Ä–∞—Ç—å –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–≤ ADR/Guide/Policy –∏ OpenAPI):
     - mapping –ø–æ–ª–µ–π `knowledge.similarity_edges` + `knowledge.doc_metadata` ‚Üí API `nodes/edges`,
     - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ `v1`,
     - fallback-–ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ–ø–æ–ª–Ω–æ–π metadata,
     - –ø–ª–∞–Ω —ç–≤–æ–ª—é—Ü–∏–∏ `v1.1+`.
  2. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–≥–∏–π API-–∫–æ–Ω—Ç—Ä–∞–∫—Ç `v1` —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –∏ edge-case –ø—Ä–∞–≤–∏–ª–∞–º–∏:
     - —Ñ–∏–ª—å—Ç—Ä—ã `channels / years / authors / rubrics / categories` —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `knowledge.doc_metadata`,
     - `knowledge.documents.meta` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ v1 –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã,
     - metadata-gap (`edge` –±–µ–∑ –æ–±–µ–∏—Ö metadata-–Ω–æ–¥) –∏—Å–∫–ª—é—á–∞–µ—Ç—Å—è –∏–∑ –æ—Ç–≤–µ—Ç–∞ –∏ –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ `data_gap`.
  3. –ö–∞–Ω–æ–Ω–∏—á–Ω–æ–µ mapping-–ø—Ä–∞–≤–∏–ª–æ:
     - `edges.source_id` ‚Üí `nodes.id` (`source`), `edges.target_id` ‚Üí `nodes.id` (`target`),
     - `edges.weight` ‚Üí `edges.weight` (float, –¥–∏–∞–ø–∞–∑–æ–Ω `[0.0, 1.0]`),
     - metadata-–∞—Ç—Ä–∏–±—É—Ç—ã —É–∑–ª–∞ (`year`, `channels`, `authors`, `rubric_ids`, `category_ids`, `meta`) –±–µ—Ä—É—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑ `knowledge.doc_metadata`.
  4. Fallback –ø—Ä–∏ –Ω–µ–ø–æ–ª–Ω–æ–π metadata:
     - –µ—Å–ª–∏ —É —É–∑–ª–∞ –Ω–µ—Ç `label`, –≤–µ—Ä–Ω—É—Ç—å `label = id`,
     - –µ—Å–ª–∏ –Ω–µ—Ç –º–∞—Å—Å–∏–≤–Ω—ã—Ö –ø–æ–ª–µ–π (`channels`, `authors`, `rubric_ids`, `category_ids`), –≤–µ—Ä–Ω—É—Ç—å –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã,
     - –µ—Å–ª–∏ –Ω–µ—Ç `year`, –≤–µ—Ä–Ω—É—Ç—å `year = null`,
     - –µ—Å–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–¥–Ω–∞ –∏–∑ –Ω–æ–¥ —Ä–µ–±—Ä–∞, —Ä–µ–±—Ä–æ –Ω–µ –≤–∫–ª—é—á–∞—Ç—å –≤ –≤—ã–¥–∞—á—É.

- [ ] **–ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏ endpoint `GET /v1/graph`**
  1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `GET /v1/graph`.
  2. Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
     - `channels` (–ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–π param, –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ),
     - `year_from`, `year_to`,
     - `rubric_ids`, `category_ids` (—Å–ø–∏—Å–∫–∏ slug),
     - `authors` (—Å–ø–∏—Å–∫–∏ id/–∏–º—ë–Ω),
     - `limit_nodes` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ): `default=200`, `max=1000`.
  3. –ö–æ–¥—ã –æ—Ç–≤–µ—Ç–æ–≤ –∏ –ø—Ä–∏—á–∏–Ω—ã:
     - `200 OK`: –≤–∞–ª–∏–¥–Ω—ã–π –æ—Ç–≤–µ—Ç `nodes + edges + meta` (–≤–∫–ª—é—á–∞—è –ø—É—Å—Ç–æ–π –Ω–∞–±–æ—Ä),
     - `400 Bad Request`: —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π query (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ—á–∏—Å–ª–æ–≤–æ–π `limit_nodes` –ø—Ä–∏ —Ä—É—á–Ω–æ–º –ø–∞—Ä—Å–∏–Ω–≥–µ),
     - `422 Unprocessable Entity`: —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏ –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (`year_from > year_to`, `limit_nodes < 1` –∏–ª–∏ `> 1000`),
     - `500 Internal Server Error`: –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞/–¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î.
  4. Response-–∫–æ–Ω—Ç—Ä–∞–∫—Ç:
     - `nodes`: `[{ id, type, label, year, channels, rubric_ids, category_ids, authors, meta }]`
     - `edges`: `[{ source, target, type, weight, meta }]`
     - `meta`: `{"filters_applied": ..., "total_nodes": ..., "total_edges": ..., "truncated": bool}`
     - JSON-—Å—Ö–µ–º–∞ `meta.filters_applied`:
       - `{"channels": string[], "years": {"from": int|null, "to": int|null}, "authors": string[], "rubric_ids": string[], "category_ids": string[], "limit_nodes": int}`.
  5. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –≤—ã–±–æ—Ä–∫–∏ –∏ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º–∞:
     - —Ç–æ–ª—å–∫–æ publish-posts,
     - —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ —Ä—ë–±—Ä–∞ semantic graph,
     - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ `nodes`: –ø–æ `year DESC NULLS LAST`, –∑–∞—Ç–µ–º `id ASC`,
     - —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ `edges`: –ø–æ `weight DESC`, –∑–∞—Ç–µ–º `source ASC`, –∑–∞—Ç–µ–º `target ASC`.
  6. Edge-cases –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –≤—ã–¥–∞—á–∏:
     - –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: –≤–µ—Ä–Ω—É—Ç—å `200` –∏ `{ "nodes": [], "edges": [], "meta": {"total_nodes": 0, "total_edges": 0, "truncated": false, ...}}`,
     - –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ `limit_nodes`: –≤–µ—Ä–Ω—É—Ç—å –ø–µ—Ä–≤—ã–µ `limit_nodes` —É–∑–ª–æ–≤ –ø–æ –ø—Ä–∞–≤–∏–ª—É —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏ —Ç–æ–ª—å–∫–æ —Ä—ë–±—Ä–∞ –º–µ–∂–¥—É –Ω–∏–º–∏; `meta.truncated = true`,
     - policy –ø–æ –¥—É–±–ª—è–º —Ä—ë–±–µ—Ä: –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–∞—Ä—É –∫–∞–∫ `min(source,target)|max(source,target)` –¥–ª—è —Ç–∏–ø–∞ `SIMILAR_UNDIRECTED`, —Ö—Ä–∞–Ω–∏—Ç—å/–≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –æ–¥–Ω–æ —Ä–µ–±—Ä–æ –Ω–∞ –ø–∞—Ä—É —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º `weight`; –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ä—ë–±—Ä–∞ (`type != SIMILAR_UNDIRECTED`) –Ω–µ —Å—Ö–ª–æ–ø—ã–≤–∞—Ç—å.
  7. –î–æ–±–∞–≤–∏—Ç—å 1‚Äì2 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω—ã—Ö –ø—Ä–∏–º–µ—Ä–∞ (–≤ issue –∏–ª–∏ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –∫–∞–Ω–æ–Ω–∏—á–Ω—ã–π —Ñ–∞–π–ª –≤ `knowledge_core/source_of_truth/docs/...`).

  **–ü—Ä–∏–º–µ—Ä A (—á–∞—Å—Ç–∏—á–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã, –±–µ–∑ truncation)**

  ```http
  GET /v1/graph?channels=telegram&year_from=2023&year_to=2024&limit_nodes=3
  ```

  ```json
  {
    "nodes": [
      {
        "id": "post-2024-001",
        "type": "publish-post",
        "label": "DET weekly update",
        "year": 2024,
        "channels": ["telegram"],
        "rubric_ids": ["det-updates"],
        "category_ids": ["ecosystem"],
        "authors": ["team-det"],
        "meta": {"doc_type": "post"}
      }
    ],
    "edges": [],
    "meta": {
      "filters_applied": {
        "channels": ["telegram"],
        "years": {"from": 2023, "to": 2024},
        "authors": [],
        "rubric_ids": [],
        "category_ids": [],
        "limit_nodes": 3
      },
      "total_nodes": 1,
      "total_edges": 0,
      "truncated": false
    }
  }
  ```

  **–ü—Ä–∏–º–µ—Ä B (truncated=true –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –Ω–µ–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–µ–±—Ä–∞)**

  ```http
  GET /v1/graph?channels=site&limit_nodes=2
  ```

  ```json
  {
    "nodes": [
      {"id": "post-a", "type": "publish-post", "label": "post-a", "year": null, "channels": ["site"], "rubric_ids": [], "category_ids": [], "authors": [], "meta": {}},
      {"id": "post-b", "type": "publish-post", "label": "post-b", "year": 2024, "channels": ["site"], "rubric_ids": ["core"], "category_ids": [], "authors": ["editor"], "meta": {}}
    ],
    "edges": [
      {"source": "post-a", "target": "post-b", "type": "SIMILAR_UNDIRECTED", "weight": 0.93, "meta": {"deduplicated": true}}
    ],
    "meta": {
      "filters_applied": {
        "channels": ["site"],
        "years": {"from": null, "to": null},
        "authors": [],
        "rubric_ids": [],
        "category_ids": [],
        "limit_nodes": 2
      },
      "total_nodes": 2,
      "total_edges": 1,
      "truncated": true
    }
  }
  ```

- [ ] **API hardening: CORS, –æ—à–∏–±–∫–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**
  1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å CORS —Å allowlist —á–µ—Ä–∑ env (`API_CORS_ORIGINS`), –∑–∞–ø—Ä–µ—Ç wildcard –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
  2. –í–≤–µ—Å—Ç–∏ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫ (`HTTPException` + domain errors + –ø–æ–Ω—è—Ç–Ω—ã–π `detail` –±–µ–∑ —É—Ç–µ—á–∫–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö stack traces).
  3. –í–∫–ª—é—á–∏—Ç—å structured logs (json –∏–ª–∏ key-value) –º–∏–Ω–∏–º—É–º —Å –ø–æ–ª—è–º–∏:
     `timestamp`, `level`, `event`, `request_id`, `path`, `status_code`, `duration_ms`.
  4. –î–ª—è `/v1/graph` –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å–ª–æ —É–∑–ª–æ–≤/—Ä—ë–±–µ—Ä –∏ –ø—Ä–∏–∑–Ω–∞–∫ truncation.

- [ ] **Runtime –∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫**
  1. –î–æ–±–∞–≤–∏—Ç—å `Makefile` –≤ `detai-core/` —Å –º–∏–Ω–∏–º—É–º–æ–º —Ü–µ–ª–µ–π:
     - `make api` (–ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ uvicorn),
     - `make lint` (–µ—Å–ª–∏ –ª–∏–Ω—Ç–µ—Ä —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ),
     - `make format` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å formatter-—Å—Ç–∞–Ω–¥–∞—Ä—Ç).
  2. –î–æ–±–∞–≤–∏—Ç—å `detai-core/api/Dockerfile` –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ API.
  3. –î–æ–±–∞–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å `docker-compose.yml` (–≤ –∫–æ—Ä–Ω–µ –∏–ª–∏ –≤ `detai-core/`) —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏ API + Postgres (–∏–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –ë–î).
  4. –û–±–Ω–æ–≤–∏—Ç—å `README` —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π ¬´–∫–∞–∫ –ø–æ–¥–Ω—è—Ç—å API –ª–æ–∫–∞–ª—å–Ω–æ¬ª, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ env –∏ –ø—Ä–∏–º–µ—Ä–æ–º –∑–∞–ø—Ä–æ—Å–∞ –∫ `/v1/graph`.

- [ ] **–¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è**
  1. –î–æ–±–∞–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ API-—Ç–µ—Å—Ç—ã (unit/integration –Ω–∞ —É—Ä–æ–≤–µ–Ω—å endpoint + schema validation):
     - happy-path `/v1/graph`,
     - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `channels`,
     - `limit_nodes` truncation,
     - –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã (400/422),
     - health-check.
  2. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä OpenAPI-—Å—Ö–µ–º—ã –∏ –ø—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.
  3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–æ–º (–∏–ª–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å mock-–∫–ª–∏–µ–Ω—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏).

---

## Verification Notes
Sub-Issue —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –∫–æ–≥–¥–∞:
- `/health` –∏ `/v1/graph` –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –∑–∞–ø—É—Å–∫–µ;
- `/v1/graph` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç `nodes + edges + meta` –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç publish-–≥—Ä–∞—Ñ;
- CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω allowlist-–æ–º;
- API –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `make api` –∏ —á–µ—Ä–µ–∑ Docker/Compose;
- –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã endpoint –ø—Ä–æ—Ö–æ–¥—è—Ç;
- README –∏ OpenAPI –æ—Ç—Ä–∞–∂–∞—é—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç.

## Document package
- ADR: 
- Guide: 
- Policy: 

## üöö Delivery
Branch: `<branch-name>`
PR: `<#id or link>`
