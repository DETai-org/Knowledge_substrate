# Sub-Issue 2: Semantic Graph API (v1) & API Service Hardening

## Title
–í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API-—Å–µ—Ä–≤–∏—Å semantic graph –¥–ª—è publish-–ø–æ—Å—Ç–æ–≤ —Å –±–∞–∑–æ–≤—ã–º production-–∫–æ–Ω—Ç—É—Ä–æ–º.

## Purpose üéØ
–ü–æ—Å–ª–µ –º–µ—Ä–¥–∂–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —É—Å—Ç–æ–π—á–∏–≤—ã–π API-—Å–ª–æ–π –¥–ª—è –≤—ã–¥–∞—á–∏ semantic graph –≤ —Ñ–æ—Ä–º–∞—Ç–µ `nodes + edges` —á–µ—Ä–µ–∑ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π endpoint `/v1/graph`.  
–≠—Ç–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç data-pipeline (Sub-Issue 1) –∫ –ø–æ—Ç—Ä–µ–±–ª—è–µ–º–æ–º—É —Å–µ—Ä–≤–∏—Å–Ω–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –¥–ª—è —Å–∞–π—Ç–∞/–∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –ø—Ä–æ–¥–≤–∏–≥–∞–µ—Ç Epic –∫ –ø–µ—Ä–≤–æ–º—É —Ä–µ–ª–∏–∑–Ω–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é knowledge layer.

---

## Tasks (Acceptance Checklist)

- [ ] –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ API-—Å–µ—Ä–≤–∏—Å–∞: –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è FastAPI –ø–æ –º–æ–¥—É–ª—è–º
  1. –í–Ω—É—Ç—Ä–∏ `detai-core/api/app/` –≤—ã–¥–µ–ª–∏—Ç—å:
     - `main.py` (—Å–æ–∑–¥–∞–Ω–∏–µ app + middleware + include_router),
     - `routers/health.py`,
     - `routers/graph.py`,
     - `schemas/graph.py`,
     - `services/graph_query.py`,
     - `core/config.py` (env/config),
     - `core/logging.py` (structured logging).
  2. –£–±—Ä–∞—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É SQL –∏–∑ `main.py` –≤ service-—Å–ª–æ–π.
  3. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞—Ç–Ω—É—é —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å `/health` (–∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å breaking-change –≤ Notes).

- [ ] –ö–æ–Ω—Ç—Ä–∞–∫—Ç –∏ endpoint `GET /v1/graph`
  1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å endpoint `GET /v1/graph`.
  2. Query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã:
     - `channels` (–ø–æ–≤—Ç–æ—Ä—è–µ–º—ã–π param, –º–∏–Ω–∏–º—É–º –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ),
     - `year_from`, `year_to`,
     - `rubric_ids`, `category_ids` (—Å–ø–∏—Å–∫–∏ slug),
     - `authors` (—Å–ø–∏—Å–∫–∏ id/–∏–º—ë–Ω),
     - `limit_nodes` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, default + max cap).
  3. Response-–∫–æ–Ω—Ç—Ä–∞–∫—Ç:
     - `nodes`: `[{ id, type, label, year, channels, rubric_ids, category_ids, authors, meta }]`
     - `edges`: `[{ source, target, type, weight, meta }]`
     - `meta`: `{"filters_applied": ..., "total_nodes": ..., "total_edges": ..., "truncated": bool}`
  4. –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –≤—ã–±–æ—Ä–∫–∏:
     - —Ç–æ–ª—å–∫–æ publish-posts,
     - —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–µ —Ä—ë–±—Ä–∞ semantic graph,
     - —Å—Ç–∞–±–∏–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞/–¥–µ—Ç–µ—Ä–º–∏–Ω–∏–∑–º –æ—Ç–≤–µ—Ç–∞.
  5. –î–æ–±–∞–≤–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ (`year_from <= year_to`, `limit_nodes` –≤ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö, –ø—É—Å—Ç—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –Ω–µ –ª–æ–º–∞—é—Ç –≤—ã–¥–∞—á—É).

- [ ] API hardening: CORS, –æ—à–∏–±–∫–∏, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
  1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å CORS —Å allowlist —á–µ—Ä–∑ env (`API_CORS_ORIGINS`), –∑–∞–ø—Ä–µ—Ç wildcard –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
  2. –í–≤–µ—Å—Ç–∏ –µ–¥–∏–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—à–∏–±–æ–∫ (`HTTPException` + domain errors + –ø–æ–Ω—è—Ç–Ω—ã–π `detail` –±–µ–∑ —É—Ç–µ—á–∫–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö stack traces).
  3. –í–∫–ª—é—á–∏—Ç—å structured logs (json –∏–ª–∏ key-value) –º–∏–Ω–∏–º—É–º —Å –ø–æ–ª—è–º–∏:
     `timestamp`, `level`, `event`, `request_id`, `path`, `status_code`, `duration_ms`.
  4. –î–ª—è `/v1/graph` –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —á–∏—Å–ª–æ —É–∑–ª–æ–≤/—Ä—ë–±–µ—Ä –∏ –ø—Ä–∏–∑–Ω–∞–∫ truncation.

- [ ] Runtime –∏ –ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
  1. –î–æ–±–∞–≤–∏—Ç—å `Makefile` –≤ `detai-core/` —Å –º–∏–Ω–∏–º—É–º–æ–º —Ü–µ–ª–µ–π:
     - `make api` (–ª–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ uvicorn),
     - `make lint` (–µ—Å–ª–∏ –ª–∏–Ω—Ç–µ—Ä —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ),
     - `make format` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å formatter-—Å—Ç–∞–Ω–¥–∞—Ä—Ç).
  2. –î–æ–±–∞–≤–∏—Ç—å `detai-core/api/Dockerfile` –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ API.
  3. –î–æ–±–∞–≤–∏—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å `docker-compose.yml` (–≤ –∫–æ—Ä–Ω–µ –∏–ª–∏ –≤ `detai-core/`) —Å —Å–µ—Ä–≤–∏—Å–∞–º–∏ API + Postgres (–∏–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –ë–î).
  4. –û–±–Ω–æ–≤–∏—Ç—å `README` —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π ¬´–∫–∞–∫ –ø–æ–¥–Ω—è—Ç—å API –ª–æ–∫–∞–ª—å–Ω–æ¬ª, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º–∏ env –∏ –ø—Ä–∏–º–µ—Ä–æ–º –∑–∞–ø—Ä–æ—Å–∞ –∫ `/v1/graph`.

- [ ] –¢–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–Ω–∞—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è
  1. –î–æ–±–∞–≤–∏—Ç—å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ API-—Ç–µ—Å—Ç—ã (unit/integration –Ω–∞ —É—Ä–æ–≤–µ–Ω—å endpoint + schema validation):
     - happy-path `/v1/graph`,
     - —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ `channels`,
     - `limit_nodes` truncation,
     - –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ query-–ø–∞—Ä–∞–º–µ—Ç—Ä—ã (400/422),
     - health-check.
  2. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä OpenAPI-—Å—Ö–µ–º—ã –∏ –ø—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.
  3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –ø–æ—Ç—Ä–µ–±–ª—è–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç–æ–º (–∏–ª–∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å mock-–∫–ª–∏–µ–Ω—Ç –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏).

- [ ] –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ data-contract –º–µ–∂–¥—É ingest –∏ API
  1. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª–µ–π –∏–∑ `knowledge.similarity_edges` –∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –≤ API-–º–æ–¥–µ–ª—å —É–∑–ª–æ–≤/—Ä—ë–±–µ—Ä.
  2. –Ø–≤–Ω–æ –æ–ø–∏—Å–∞—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é, –∫–∞–∫ –ø–æ–ª—É—á–∞—Ç—å node metadata (channels, —Ä—É–±—Ä–∏–∫–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∞–≤—Ç–æ—Ä—ã, –≥–æ–¥—ã), –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ `knowledge.documents`.
  3. –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏ (`v1`) –∏ —ç–≤–æ–ª—é—Ü–∏–æ–Ω–Ω—ã–π –ø—É—Ç—å (`v1.1+`).

---

## Verification Notes
Sub-Issue —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º, –∫–æ–≥–¥–∞:
- `/health` –∏ `/v1/graph` –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º –∑–∞–ø—É—Å–∫–µ;
- `/v1/graph` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç `nodes + edges + meta` –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç publish-–≥—Ä–∞—Ñ;
- CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω allowlist-–æ–º;
- API –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `make api` –∏ —á–µ—Ä–µ–∑ Docker/Compose;
- –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã endpoint –ø—Ä–æ—Ö–æ–¥—è—Ç;
- README –∏ OpenAPI –æ—Ç—Ä–∞–∂–∞—é—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç.

## Document package
- ADR: `knowledge_core/ADR/adr-0002-semantic-graph-api-v1.md`
- Guide: `knowledge_core/guides/guide-semantic-graph-api-v1.md`
- Policy: `knowledge_core/Policy/policy-semantic-graph-api-v1.md`

## üöö Delivery
Branch: `<branch-name>`
PR: `<#id or link>`
